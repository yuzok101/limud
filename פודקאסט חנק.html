<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×¤×•×“×§××¡×˜ ×—× ×§</title>
<link rel="icon" type="image/png" href="logo.png">

<style>
:root {
    --deep-blue: #0d1b2a;
    --light-blue: #1b263b;
    --accent-blue: #415a77;
    --text-color: #e0e1dd;
}
* { box-sizing: border-box; }

body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: var(--deep-blue);
    color: var(--text-color);
}
body.loading { overflow: hidden; }

/* ×¡×¤×œ×© */
#splash {
    position: fixed;
    inset: 0;
    background: var(--deep-blue);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
#splashLogo {
    width: 120px;
    height: 120px;
    animation: spin 2s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ×¡×¨×’×œ ×¢×œ×™×•×Ÿ */
#topBar {
    position: fixed;
    top: 10px;
    left: 10px;
    right: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 1000;
}
#profileBtn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background: red;
    color: white;
    font-size: 24px;
    cursor: pointer;
}
#topLogo {
    width: 50px;
    height: 50px;
    cursor: pointer;
}

/* ×›×•×ª×¨×•×ª */
h1 {
    text-align: center;
    margin-top: 80px;
    margin-bottom: 30px;
    font-size: 2rem;
    color: var(--accent-blue);
    text-shadow: 1px 1px 4px black;
}
#userNameDisplay {
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.2rem;
}

/* Grid */
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 25px;
}
.card {
    background: var(--light-blue);
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.5);
    padding: 15px;
    text-align: center;
    transform: scale(0.9);
    opacity: 0;
    transition: all 0.8s ease-out;
}
.card.show {
    transform: scale(1);
    opacity: 1;
}
.card h2 {
    font-size: 18px;
    margin-bottom: 12px;
}
.card iframe {
    width: 100%;
    height: 300px;
    border-radius: 8px;
    border: none;
}

/* ×›×¤×ª×•×¨ ×”×•×¨×“×” */
.download-btn {
    margin-top: 12px;
    padding: 8px 16px;
    background: var(--accent-blue);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
}
.download-btn:hover {
    opacity: 0.85;
}

@media (max-width: 768px) {
    .card iframe { height: 220px; }
}
@media (max-width: 480px) {
    .card iframe { height: 180px; }
}
</style>
</head>

<body class="loading" data-category="×¤×•×“×§××¡×˜ ×—× ×§">

<!-- ×¡×¤×œ×© -->
<div id="splash">
    <img src="logo.png" id="splashLogo">
</div>

<!-- ×¡×¨×’×œ ×¢×œ×™×•×Ÿ -->
<div id="topBar">
    <button id="profileBtn">ğŸ‘¤</button>
    <img src="logo.png" id="topLogo">
</div>

<h1>×¤×•×“×§××¡×˜ ×—× ×§</h1>
<div id="userNameDisplay"></div>
<div class="grid" id="mediaGrid"></div>

<script>
// ×‘×“×™×§×ª ×”×ª×—×‘×¨×•×ª
const user = JSON.parse(localStorage.getItem('loggedInUser'));
if (!user) location.href = 'login1.html';
else document.getElementById('userNameDisplay').textContent =
    `×©×œ×•×, ${user.firstName} ${user.lastName}`;

profileBtn.onclick = () => location.href = 'login1.html';
topLogo.onclick = () => location.href = 'media-index.html';

// Google Sheets CSV
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDcF3fujTQ-PQG1vd2QJkFWkzXoUOTwPsQ1gglHXKeN1XynSddJVs4EMGK744t3D2hnRuM891-HVzU/pub?output=csv';

async function loadMedia() {
    const res = await fetch(csvUrl);
    const text = await res.text();
    const rows = text.split('\n').map(r => r.split(','));
    const container = document.getElementById('mediaGrid');
    const category = document.body.dataset.category;

    rows.forEach((row, i) => {
        if (i === 0) return;
        const title = row[1]?.trim();
        const link = row[2]?.trim();
        const cat = row[3]?.trim();
        if (!title || !link || cat !== category) return;

        const card = document.createElement('div');
        card.className = 'card';

        const h2 = document.createElement('h2');
        h2.textContent = title;

        let iframe = document.createElement('iframe');
        let src = link;

        if (link.includes('youtube')) {
            src = link.replace('watch?v=', 'embed/');
        } else if (link.includes('drive.google.com/file')) {
            const id = link.match(/\/d\/(.+?)\//)?.[1];
            if (id) src = `https://drive.google.com/file/d/${id}/preview`;
        }

        iframe.src = src;
        iframe.allowFullscreen = true;

        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'download-btn';
        downloadBtn.textContent = 'â¬‡ ×”×•×¨×“×”';
        downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = link;
            a.target = '_blank';
            a.download = '';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        card.append(h2, iframe, downloadBtn);
        container.appendChild(card);
        setTimeout(() => card.classList.add('show'), i * 150);
    });
}

async function start() {
    await loadMedia();
    splash.style.display = 'none';
    document.body.classList.remove('loading');
}
start();
</script>

<!-- Firebase -->
<script type="module">
import { db } from "./firebase.js";
import { collection, doc, setDoc, addDoc, serverTimestamp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

let visitorId = localStorage.getItem("visitorId");
if (!visitorId) {
    visitorId = crypto.randomUUID();
    localStorage.setItem("visitorId", visitorId);
}

async function updateLive() {
    await setDoc(doc(db, "liveVisitors", visitorId), {
        page: location.pathname,
        lastSeen: serverTimestamp()
    });
}
async function pageView() {
    await addDoc(collection(db, "pageViews"), {
        visitorId,
        page: location.pathname,
        timestamp: serverTimestamp()
    });
}

updateLive();
pageView();
setInterval(updateLive, 30000);
</script>

</body>
</html>
