<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>דו"ח מתקדם</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap');

body { margin:0; font-family:'Assistant',sans-serif; background:#0b1f3a; color:#fff; }
header { background:#0a1630; padding:20px; text-align:center; font-size:2rem; font-weight:bold; color:#00aaff; box-shadow:0 4px 6px rgba(0,0,0,0.3);}
.container { max-width:1200px; margin:30px auto; padding:0 20px;}
table { width:100%; border-collapse: collapse; background:#12294f; border-radius: 10px; overflow:hidden; }
th, td { padding:12px 15px; text-align:center; }
th { background:#0a1630; color:#00aaff; font-weight:bold; }
tr:nth-child(even) { background:#0f2a51; }
tr:hover { background:#0c1f3d; }
button.btn { background:#005f99; color:#fff; padding:10px 15px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition: background 0.3s; margin-bottom:20px;}
button.btn:hover { background:#00aaff; }
#filter { margin-bottom:20px; padding:10px; border-radius:8px; border:none; }
</style>
</head>
<body>

<header>דו"ח מתקדם - משתמשים וקורסים</header>

<div class="container">
  <label>סנן לפי קורס:</label>
  <select id="filter" onchange="renderTable(usersData)">
    <option value="">כל הקורסים</option>
  </select>
  <button class="btn" onclick="exportCSV()">ייצא CSV</button>
  
  <table id="usersTable">
    <thead>
      <tr>
        <th>שם משתמש</th>
        <th>קורס</th>
        <th>אחוז צפייה</th>
        <th>ציון מבחן</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="margin-top:30px;">
    <canvas id="gradeChart" width="400" height="200"></canvas>
  </div>
</div>

<script>
// התיקון: החלפת ה-Placeholder בכתובת ה-Web App שסופקה
const API_URL = "https://script.google.com/macros/s/AKfycbxguZIdBZKUHrTy-8hLMxYIXCV7g5bsVNY3mOQgg1AU0v2giTisXG51lspgHeloXwHr/exec";
let usersData = [];

function fetchUsersData(){
  fetch(`${API_URL}?action=getAllUsersProgress`)
    .then(res=>res.json())
    .then(data=>{
      usersData = data;
      populateFilter(data);
      renderTable(data);
      renderChart(data);
    });
}

function populateFilter(data){
  const filter = document.getElementById("filter");
  const courses = [...new Set(data.map(u=>u.course))];
  courses.forEach(c=>{
    const option = document.createElement("option");
    option.value = c;
    option.textContent = c;
    filter.appendChild(option);
  });
}

function renderTable(data){
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";
  const filterVal = document.getElementById("filter").value;
  
  data.filter(u=>!filterVal || u.course===filterVal)
      .forEach(u=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.course}</td>
          <td>${u.videoProgress}%</td>
          <td>${u.quizScore}%</td>
        `;
        tbody.appendChild(tr);
      });
}

function renderChart(data){
  const courses = [...new Set(data.map(u=>u.course))];
  const chartData = courses.map(c=>{
    const scores = data.filter(u=>u.course===c).map(u=>u.quizScore);
    const avg = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 0;
    return avg;
  });
  
  const ctx = document.getElementById('gradeChart').getContext('2d');
  new Chart(ctx,{
    type:'bar',
    data:{
      labels:courses,
      datasets:[{label:'ציון ממוצע מבח
