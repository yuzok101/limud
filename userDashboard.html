<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>הקורסים שלי</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap');

body {
    margin: 0;
    font-family: 'Assistant', sans-serif;
    background: #0b1f3a;
    color: #fff;
    min-height: 100vh;
}

header {
    background: #0a1630;
    padding: 20px;
    text-align: center;
    font-size: 2rem;
    font-weight: bold;
    color: #00aaff;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

.container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 20px;
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(280px,1fr));
    gap: 20px;
}

.card {
    background: #12294f;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.card h3 {
    margin-top: 0;
    color: #00aaff;
}

.card video {
    width: 100%;
    border-radius: 8px;
}

/* מניעת הורדה קלה */
video::-internal-media-controls-download-button { display:none; }
video::-webkit-media-controls-enclosure { overflow:hidden; }
video::-webkit-media-controls-panel { width: calc(100% + 30px); }
</style>
</head>
<body>

<header>הקורסים שלי</header>

<div class="container" id="coursesContainer">
  </div>

<script>
// התיקון: החלפת ה-Placeholder בכתובת ה-Web App שסופקה
const API_URL = "https://script.google.com/macros/s/AKfycbxguZIdBZKUHrTy-8hLMxYIXCV7g5bsVNY3mOQgg1AU0v2giTisXG51lspgHeloXwHr/exec";
const userId = sessionStorage.getItem("userId") || "demoUser"; // קבלת הקורסים מהשרת

function fetchCourses() {
  fetch(`${API_URL}?action=getCourses`)
    .then(res=>res.json())
    .then(courses=>{
      courses.forEach(course=>{
        addCourseCard(course);
      });
    });
}

function addCourseCard(course){
  const container = document.getElementById("coursesContainer");
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <h3>${course.title}</h3>
    <p>${course.description}</p>
    ${course.lessons.map(lesson=>`
      <div style="margin-top:10px;">
        <strong>${lesson.title}</strong><br>
        <video controls controlsList="nodownload" onplay="registerView('${course.courseId}','${lesson.lessonId}')" onended="markCompleted('${course.courseId}','${lesson.lessonId}')">
          <source src="${lesson.videoUrl}" type="video/mp4">
          הדפדפן שלך לא תומך בסרטונים.
        </video>
      </div>
    `).join('')}
  `;
  container.appendChild(card);
}

// רישום צפייה
function registerView(courseId, lessonId){
  fetch(`${API_URL}?action=addVideoView&userId=${userId}&courseId=${courseId}&lessonId=${lessonId}`)
    .then(res=>res.json())
    .then(data=>{
      if(data.success){
        updateLessonStatus(courseId, lessonId, 'InProgress');
      }
    });
}

// עדכון סטטוס שיעור
function updateLessonStatus(courseId, lessonId, status){
  fetch(`${API_URL}?action=updateLessonStatus&userId=${userId}&courseId=${courseId}&lessonId=${lessonId}&status=${status}`)
    .then(res=>res.json())
    .then(data=>{
      if(!data.success){
        console.error("Failed to update lesson status:", data.message);
      }
    });
}

// סימון כהושלם
function markCompleted(courseId, lessonId){
  updateLessonStatus(courseId, lessonId, 'Completed');
}

fetchCourses();
</script>

</body>
</html>
