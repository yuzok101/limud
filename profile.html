<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>驻专 砖 砖</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Assistant', sans-serif;
  margin: 0;
  padding: 0;
  background: url('images/profil.png') no-repeat center center fixed;
  background-size: cover;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding-top: 50px;
}

.card {
  background: rgba(255,255,255,0.95);
  padding: 30px 25px;
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  gap: 20px;
  transition: transform 0.3s, box-shadow 0.3s;
  position: relative;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 40px rgba(0,0,0,0.3);
}

.card:active {
  transform: translateY(0);
  box-shadow: 0 6px 15px rgba(0,0,0,0.2);
}

.card img.logo {
  display: block;
  margin: 0 auto 20px auto;
  width: 120px;
  transition: transform 0.3s;
}

.card img.logo:hover {
  transform: scale(1.1);
}

h2 {
  text-align: center;
  margin-bottom: 15px;
  font-weight: 700;
  color: #003366;
}

.field-card {
  background: #f5faff;
  padding: 12px 15px;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  position: relative;
  transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
}

.field-card:hover {
  transform: scale(1.02);
  box-shadow: 0 5px 15px rgba(0,191,255,0.2);
}

.field-card:active {
  transform: scale(0.99);
  box-shadow: 0 3px 8px rgba(0,191,255,0.3);
}

.field-card input {
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid #003366;
  outline: none;
  font-size: 14px;
  background: #ffffff;
  color: #003366;
  transition: background 0.3s, box-shadow 0.3s, transform 0.1s;
}

.field-card input:disabled {
  background: #e0e0e0;
  color: #555;
}

.field-card input:focus {
  background: #e6f7ff;
  box-shadow: 0 0 8px #00bfff;
}

.field-card button.editBtn {
  position: absolute;
  top: 10px;
  left: 10px;
  background: #00bfff;
  border: none;
  color: white;
  padding: 5px 10px;
  font-size: 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.field-card button.editBtn:hover {
  background: #0099cc;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,191,255,0.4);
}

.field-card button.editBtn:active {
  transform: translateY(0) scale(0.95);
  box-shadow: 0 2px 6px rgba(0,191,255,0.3);
}

button.saveBtn {
  margin-top: 10px;
  padding: 12px;
  border: none;
  border-radius: 12px;
  background: #003366;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
}

button.saveBtn:hover {
  background: #0055aa;
  transform: translateY(-2px);
  box-shadow: 0 8px 22px rgba(0,0,0,0.3);
}

button.saveBtn:active {
  transform: translateY(0) scale(0.97);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.notice {
  margin-top: 10px;
  background: #fffae6;
  color: #cc0000;
  padding: 12px;
  border-radius: 12px;
  text-align: center;
  font-weight: 600;
}

#spinner {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 60px;
  height: 60px;
  border: 6px solid #e0e0e0;
  border-top: 6px solid #00bfff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  z-index: 100;
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}

@media (max-width: 480px){
  .card { padding: 20px; width: 95%; }
  .field-card input { font-size: 13px; }
  button.saveBtn { font-size: 15px; }
}
</style>
</head>

<body>
<div class="card">
  <img src="logo.png" alt="" class="logo">
  <h2>驻专 砖 砖</h2>

  <div id="spinner"></div>
  <div id="profile" style="display:none;"></div>

  <button class="saveBtn" onclick="saveChanges()"> 砖专 砖</button>
  <div id="courseNotice"></div>
</div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbz8aZ1RIeeeCjMXHVjEpd4gFYl3xVzwdTwp1YSwT8Np0KxhtdY484uriBdj_XxDQvMe/exec';

const user = JSON.parse(localStorage.getItem('loggedInUser'));
if(!user){
  alert(" 专");
  location.href = "login1.html";
}

const id = user.id;

function isValidEmail(email){
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

async function loadProfile(){
  try {
    const res = await fetch(scriptURL, {
      method:'POST',
      body:new URLSearchParams({ action:'getProfile', id })
    });
    const data = await res.json();
    if(!data.success){
      alert("砖 注转 转: " + (data.message || ""));
      return;
    }
    renderProfile(data);
    checkExpiry(data.expiryDate);
  } catch(err){
    console.error(err);
    alert("砖 注转 转");
  } finally {
    document.getElementById('spinner').style.display = 'none';
    document.getElementById('profile').style.display = 'block';
  }
}

function renderProfile(d){
  const profileDiv = document.getElementById('profile');
  profileDiv.innerHTML = `
    <div class="field-card"><strong>转注转 转:</strong> ${d.id}</div>
    <div class="field-card"><strong>砖:</strong> ${d.firstName} ${d.lastName}</div>
    <div class="field-card">
      <strong>:</strong>
      <input id="email" value="${d.email || ''}" disabled>
      <button class="editBtn" onclick="enableEdit('email')">注专</button>
    </div>
    <div class="field-card">
      <strong>驻:</strong>
      <input id="phone" value="${d.phone || ''}" disabled>
      <button class="editBtn" onclick="enableEdit('phone')">注专</button>
    </div>
    <div class="field-card">
      <strong>转转:</strong>
      <input id="address" value="${d.address || ''}" disabled>
      <button class="editBtn" onclick="enableEdit('address')">注专</button>
    </div>
    <div class="field-card"><strong>砖专:</strong> ${d.training || ''}</div>
    <div class="field-card"><strong>转专 住 拽专住:</strong> ${d.courseEnd || ''}</div>
    <div class="field-card"><strong>转拽祝 砖专:</strong> ${d.expiryDate || ''}</div>
    <div class="field-card"><strong>转注:</strong> <a href="${d.certificate}" target="_blank" style="color:#00bfff">专</a></div>
  `;
}

function enableEdit(fieldId){
  const input = document.getElementById(fieldId);
  input.disabled = false;
  input.focus();
  input.style.background = "#e6f7ff";
  input.style.boxShadow = "0 0 10px #00bfff";
}

async function saveChanges(){
  const email = document.getElementById('email').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const address = document.getElementById('address').value.trim();

  if(!isValidEmail(email)){
    alert("  转拽");
    return;
  }

  try{
    const res = await fetch(scriptURL, {
      method:'POST',
      body:new URLSearchParams({
        action:'updateProfile',
        id,
        email,
        phone,
        address
      })
    });
    const data = await res.json();
    if(data.success){
      alert("驻专 注 爪");
      ['email','phone','address'].forEach(f => {
        const input = document.getElementById(f);
        input.disabled = true;
        input.style.background = "#ffffff";
        input.style.boxShadow = "none";
      });
    } else {
      alert("砖 注: " + (data.message || ""));
    }
  } catch(err){
    console.error(err);
    alert("砖 注 转");
  }
}

function checkExpiry(dateStr){
  if(!dateStr) return;
  const expiry = new Date(dateStr);
  const now = new Date();
  const sixMonths = 1000*60*60*24*180;
  if(expiry - now <= sixMonths){
    document.getElementById('courseNotice').innerHTML = `
      <div class="notice">
        转拽祝 砖专 注 驻 爪 砖 拽专!<br>
        <button onclick="location.href='courses.html'">专砖 拽专住 砖</button>
      </div>
    `;
  }
}

loadProfile();
</script>
</body>
</html>
