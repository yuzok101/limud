<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>מבחן קורס</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap');

body {
    margin: 0;
    font-family: 'Assistant', sans-serif;
    background: #0b1f3a;
    color: #fff;
    min-height: 100vh;
}

header {
    background: #0a1630;
    padding: 20px;
    text-align: center;
    font-size: 2rem;
    font-weight: bold;
    color: #00aaff;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

.container {
    max-width: 800px;
    margin: 30px auto;
    padding: 0 20px;
}

.question-card {
    background: #12294f;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.question-card h4 {
    margin-top: 0;
    color: #00aaff;
}

input[type="text"] {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
}

button.btn {
    background: #005f99;
    color: #fff;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s;
}

button.btn:hover {
    background: #00aaff;
}

#score {
    margin-top: 20px;
    font-size: 1.4rem;
    font-weight: bold;
    color: #00ff99;
}
</style>
</head>
<body>

<header>מבחן קורס</header>

<div class="container" id="quizContainer">
  </div>

<div class="container">
  <button class="btn" onclick="submitQuiz()">שלח את המבחן</button>
  <div id="score"></div>
</div>

<script>
// התיקון: החלפת ה-Placeholder בכתובת ה-Web App שסופקה
const API_URL = "https://script.google.com/macros/s/AKfycbxguZIdBZKUHrTy-8hLMxYIXCV7g5bsVNY3mOQgg1AU0v2giTisXG51lspgHeloXwHr/exec";
const urlParams = new URLSearchParams(window.location.search);
const userId = sessionStorage.getItem("userId") || "demoUser"; 
const courseId = urlParams.get('courseId');

let quizQuestions = [];

// טען שאלות מבחן מהשרת
function fetchQuiz(){
  fetch(`${API_URL}?action=getQuiz&courseId=${courseId}`)
    .then(res=>res.json())
    .then(data=>{
      quizQuestions = data;
      // התיקון: הסרת התשובה הנכונה מהאובייקט בצד הלקוח כדי למנוע חשיפה
      quizQuestions.forEach(q => delete q.answer); 
      renderQuiz();
    });
}

// הצגת השאלות
function renderQuiz(){
  const container = document.getElementById("quizContainer");
  container.innerHTML = "";
  quizQuestions.forEach((q,index)=>{
    const card = document.createElement("div");
    card.className = "question-card";
    card.innerHTML = `
      <h4>שאלה ${index+1}: ${q.question}</h4>
      <input type="text" id="answer_${q.quizId}" placeholder="תשובה">
    `;
    container.appendChild(card);
  });
}

// שליחת המבחן
function submitQuiz(){
  let results = [];

  quizQuestions.forEach(q=>{
    const answer = document.getElementById(`answer_${q.quizId}`).value.trim();
    results.push({
      quizId: q.quizId,
      userAnswer: answer
    });
  });

  // שליחת תוצאות לשרת - השרת יחשב את הציון ויחזיר אותו
  fetch(`${API_URL}?action=submitQuiz&userId=${userId}&courseId=${courseId}&results=${encodeURIComponent(JSON.stringify(results))}`)
    .then(res=>res.json())
    .then(data=>{
      // התיקון: ציפייה שהשרת יחזיר את הציון (score ו-maxScore)
      if(data.success && data.score !== undefined && data.maxScore !== undefined){
        const percentage = Math.round((data.score/data.maxScore)*100);
        document.getElementById("score").textContent = `הציון שלך: ${data.score}/${data.maxScore} (${percentage}%)`;
      } else if(data.success) {
        // Fallback למקרה שהשרת לא מחזיר score, כדאי לתקן את השרת
         document.getElementById("score").textContent = `המבחן נשלח בהצלחה. הציון טרם התקבל.`;
      } else {
         alert("שגיאה בשליחת המבחן: "+data.message);
      }
    });
}

fetchQuiz();
</script>

</body>
</html>
