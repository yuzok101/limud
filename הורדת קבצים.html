<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×”×•×¨×“×ª ×§×‘×¦×™× ×¢× PDF Preview</title>
<link rel="icon" type="image/png" href="logo.png">

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.12.313/pdf.min.js" defer></script>

<style>
:root {
    --deep-blue:#0d1b2a;
    --light-blue:#1b263b;
    --accent-blue:#415a77;
    --text-color:#e0e1dd;
}
*{box-sizing:border-box}
body{
    margin:0;
    padding:20px;
    font-family:Arial;
    background:var(--deep-blue);
    color:var(--text-color);
}
body.loading{overflow:hidden}

#splash{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:var(--deep-blue);
    z-index:9999;
}
#splashLogo{
    width:120px;
    animation:spin 2s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

#topBar{
    position:fixed;
    top:10px;
    left:10px;
    right:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    z-index:1000;
}
#profileBtn{
    width:50px;height:50px;
    border-radius:50%;border:none;
    background:red;color:#fff;font-size:24px;
    cursor:pointer;
}
#topLogo{width:50px;cursor:pointer}

h1{margin-top:90px;text-align:center;color:var(--accent-blue);}
#userNameDisplay{text-align:center;margin-bottom:25px;}

.grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(380px,1fr));
    gap:25px;
}
.card{
    background:var(--light-blue);
    border-radius:12px;
    padding:15px;
    box-shadow:0 8px 20px rgba(0,0,0,.5);
    text-align:center;
    transform:scale(.9);
    opacity:0;
    transition:.7s;
}
.card.show{transform:scale(1);opacity:1;}
.card iframe, .pdf-canvas{width:100%;border-radius:8px;margin-top:10px;}
.pdf-canvas{background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.5);}

.download-btn{
    margin-top:12px;padding:8px 18px;
    background:var(--accent-blue);
    border:none;border-radius:8px;
    color:#fff;cursor:pointer;font-size:16px;
}
.download-btn:hover{opacity:.85;}

@media(max-width:768px){.pdf-canvas{height:220px;}}
@media(max-width:480px){.pdf-canvas{height:180px;}}
</style>
</head>
<body class="loading" data-category="×”×•×¨×“×ª ×§×‘×¦×™×">

<div id="splash"><img src="logo.png" id="splashLogo"></div>
<div id="topBar">
    <button id="profileBtn">ğŸ‘¤</button>
    <img src="logo.png" id="topLogo">
</div>

<h1>×”×•×¨×“×ª ×§×‘×¦×™×</h1>
<div id="userNameDisplay"></div>
<div class="grid" id="mediaGrid"></div>

<script defer>
document.addEventListener('DOMContentLoaded', async ()=>{
    // âš¡ PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.12.313/pdf.worker.min.js';

    const user = JSON.parse(localStorage.getItem('loggedInUser'));
    if(!user) location.href='login1.html';
    else userNameDisplay.textContent = `×©×œ×•×, ${user.firstName} ${user.lastName}`;

    profileBtn.onclick = () => location.href='login1.html';
    topLogo.onclick   = () => location.href='media-index.html';

    const csvUrl='https://docs.google.com/spreadsheets/d/e/2PACX-1vSDcF3fujTQ-PQG1vd2QJkFWkzXoUOTwPsQ1gglHXKeN1XynSddJVs4EMGK744t3D2hnRuM891-HVzU/pub?output=csv';

    async function loadMedia(){
        const res = await fetch(csvUrl);
        const text = await res.text();
        const rows = text.split('\n').map(r=>r.split(','));
        const grid = document.getElementById('mediaGrid');
        const category = document.body.dataset.category;

        for(let i=1;i<rows.length;i++){
            const r = rows[i];
            const title = r[1]?.trim();
            let link = r[2]?.replace(/^"+|"+$/g,'').replace(/\r/g,'').trim();
            const cat = r[3]?.trim();
            if(!title || !link || cat!==category) continue;

            const card = document.createElement('div');
            card.className='card';

            const h2 = document.createElement('h2');
            h2.textContent = title;
            card.appendChild(h2);

            let downloadSrc = link;

            // YouTube
            if(link.includes('youtube')){
                const iframe = document.createElement('iframe');
                iframe.src = link.replace('watch?v=','embed/');
                iframe.allowFullscreen = true;
                card.appendChild(iframe);
                downloadSrc=null;
            }
            // PDF ××§×•××™
            else if(link.toLowerCase().endsWith('.pdf')){
                const pdfCanvas = document.createElement('canvas');
                pdfCanvas.className='pdf-canvas';
                card.appendChild(pdfCanvas);

                const pdfPath = '×”×•×¨×“×”/sefer.pdf';

                const loadingTask = pdfjsLib.getDocument(pdfPath);
                loadingTask.promise.then(pdf=>{
                    pdf.getPage(1).then(page=>{
                        const viewport = page.getViewport({scale:1.2});
                        pdfCanvas.width = viewport.width;
                        pdfCanvas.height = viewport.height;
                        const renderContext = {
                            canvasContext: pdfCanvas.getContext('2d'),
                            viewport: viewport
                        };
                        page.render(renderContext);
                    });
                }).catch(err=>{
                    pdfCanvas.remove();
                    const info = document.createElement('div');
                    info.textContent='Preview ×œ× ×–××™×Ÿ â€“ ×œ×—×¥ ×¢×œ ×”×•×¨×“×”';
                    info.style.color='#fff';
                    card.appendChild(info);
                });
            }
            // ×§×‘×¦×™× ××—×¨×™×
            else{
                const info = document.createElement('div');
                info.textContent='Preview ×œ× ×–××™×Ÿ â€“ ×œ×—×¥ ×¢×œ ×”×•×¨×“×”';
                info.style.color='#fff';
                card.appendChild(info);
            }

            // ×›×¤×ª×•×¨ ×”×•×¨×“×”
            if(downloadSrc){
                const btn = document.createElement('button');
                btn.className='download-btn';
                btn.textContent='×”×•×¨×“×”';
                btn.onclick = ()=>window.open(downloadSrc,'_blank');
                card.appendChild(btn);
            }

            grid.appendChild(card);
            setTimeout(()=>card.classList.add('show'),i*120);
        }
    }

    await loadMedia();
    splash.style.display='none';
    document.body.classList.remove('loading');
});
</script>

</body>
</html>
